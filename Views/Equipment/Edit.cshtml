@using System.IO;
@using Auction.Entities.Enums
@using Newtonsoft.Json;
@using Microsoft.Extensions.Options;
@model EquipmentViewModel
@{
    ViewData["Title"] = "Edit Equipment";
}
@section stylesheet {
    <link href="~/lib/bootstrap-fileinput/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css"/>
    <link href="~/lib/bootstrap-fileinput/themes/explorer-fas/theme.css" media="all" rel="stylesheet" type="text/css"/>
    <style>
        .bodyinfo{
            min-width: auto;
            width: auto;
        }
    </style>
}
<div class="bodyinfo text-dark">
    <div class="container my-4">
        <h4>创建设备</h4>
        <hr />
        <div class="row">
            <div class="col-lg-6">
                <form asp-controller="Equipment" asp-action="Update" asp-route-id="@Model.Id" asp-route-returnurl="@ViewData["ReturnUrl"]" method="post" class="form-horizontal" role="form">
                    <div asp-validation-summary="All" class="text-danger"></div>
                    <div class="form-group">
                        <label asp-for="Code" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Code" class="form-control" />
                            <span asp-validation-for="Code" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="Name" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>
                        <div class="form-group">
                        <label asp-for="Manufacturer" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Manufacturer" class="form-control" />
                            <span asp-validation-for="Manufacturer" class="text-danger"></span>
                        </div>
                    </div>
                        <div class="form-group">
                        <label asp-for="Model" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Model" class="form-control" />
                            <span asp-validation-for="Model" class="text-danger"></span>
                        </div>
                    </div>
                        <div class="form-group">
                        <label asp-for="AuctionHouse" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="AuctionHouse" class="form-control" />
                            <span asp-validation-for="AuctionHouse" class="text-danger"></span>
                        </div>
                    </div>
                        <div class="form-group">
                        <label asp-for="Country" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Country" class="form-control" />
                            <span asp-validation-for="Country" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="City" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="City" class="form-control" />
                            <span asp-validation-for="City" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-offset-2 col-md-11">
                            <div class="checkbox">
                                <label asp-for="IsSold">
                                    <input name="IsSold" value="@CommonEnum.IsSold.Yes" id="IsSold" type="checkbox" 
                                        @if(Model.IsSold == CommonEnum.IsSold.Yes) { @Html.DisplayName("checked")} />
                                    @Html.DisplayNameFor(m => m.IsSold)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-offset-2 col-md-11">
                            <div class="checkbox">
                                <label name="IsPurchase">
                                    <input name="IsPurchase" id="IsPurchase" value="@CommonEnum.IsPurchase.Yes" type="checkbox"
                                        @if(Model.IsPurchase == CommonEnum.IsPurchase.Yes) { @Html.DisplayName("checked")} />
                                    @Html.DisplayNameFor(m => m.IsPurchase)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="ProductionDate" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="ProductionDate" class="form-control" />
                            <span asp-validation-for="ProductionDate" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="WorkingTime" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="WorkingTime" class="form-control" type="number"/>
                            <span asp-validation-for="WorkingTime" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="DealPrice" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="DealPrice" class="form-control" />
                            <span asp-validation-for="DealPrice" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="DealPriceRMB" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="DealPriceRMB" class="form-control" />
                            <span asp-validation-for="DealPriceRMB" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="Long" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Long" class="form-control" />
                            <span asp-validation-for="Long" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="Width" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Width" class="form-control" />
                            <span asp-validation-for="Width" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="Height" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Height" class="form-control" />
                            <span asp-validation-for="Height" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="Weight" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Weight" class="form-control" />
                            <span asp-validation-for="Weight" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="Volume" class="col-md-4 control-label"></label>
                        <div class="col-md-11">
                            <input asp-for="Volume" class="form-control" />
                            <span asp-validation-for="Volume" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-offset-2 col-md-11">
                            <button type="submit" class="btn btn-primary">更新设备</button>
                            <button type="reset" class="btn btn-outline-secondary">清空</button>
                        </div>
                    </div>

                    <a asp-action="Edit" asp-route-id="@Model.Id" class="fa fa-remove fa-lg" style="color: red"></a>
                </form>
            </div>
        
            <div class="col-lg-6">
                <form enctype="multipart/form-data">
                    <div class="form-group">
                        <input type="hidden" class="form-control" name="id" id="id" asp-for="Id" value="@Model.Id" placeholder="">
                    </div>
                    <div class="file-loading">
                        <input id="equipmentPhotoInput" name="photo" type="file" multiple>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row my-4 col-xl-4">
        
    </div>
</div>
@{
    var photoJson = JsonConvert.SerializeObject(Model.Photos.OrderBy(p => p.Ranking).ThenBy(p => p.LastUpdatedAt));
    var CoverPhotoName =  Model.CoverPhoto?.FileName;
}
@section Scripts {
    <script src="~/lib/bootstrap-fileinput/js/plugins/sortable.js" type="text/javascript"></script>
    <script src="~/lib/bootstrap-fileinput/js/fileinput.js" type="text/javascript"></script>
    <script src="~/lib/bootstrap-fileinput/js/locales/zh.js" type="text/javascript"></script>
    <script src="~/lib/bootstrap-fileinput/themes/fas/theme.min.js" type="text/javascript"></script>
    <script src="~/lib/bootstrap-fileinput/themes/explorer-fas/theme.js" type="text/javascript"></script>
    <script>
        $(document).ready(function () {
            var photo = @Html.Raw(photoJson);
            
            var initialPreview = []
            var initialPreviewConfig = []
            var newPhotos = []

            addData(photo)

            // {'X-XSRF-TOKEN': cookieUtil.getItem("XSRF-TOKEN")}
            var $fileInput = $("#equipmentPhotoInput")
            $fileInput.fileinput({
                "language": 'zh',
                "theme": 'explorer-fas',
                uploadUrl: "@Url.Action("UploadPhotoAsync")",
                ajaxSettings: {
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('X-XSRF-TOKEN', cookieUtil.getItem("XSRF-TOKEN"));
                    }
                },
                uploadExtraData: {
                    '__RequestVerificationToken': $('input:hidden[name="__RequestVerificationToken"]').val(),
                    'EquipmentId': '@Model.Id'
                },
                allowedFileTypes: ["image"],
                overwriteInitial: false,
                initialPreviewAsData: true,
                initialPreview: initialPreview,
                initialPreviewConfig: initialPreviewConfig
            }).on("filebatchselected", function(event, files) {
               $fileInput.fileinput("upload");
            }).on('filepreupload', function(event, data, previewId, index) {
                //data.form.append('IsCover', $("input#" + previewId).is(":checked"))
            }).on("fileuploaded", function (event, data, previewId, index) {
                console.log(index)
                addData([data.response])
                console.log(data)
                
                if(data.response.Message == "操作成功"){
                    var caption = $("#" + previewId).find(".explorer-caption")
                    caption.attr("title", data.response.Data.FileName)
                    caption.text(data.response.Data.FileName)
                    $('input:radio[name="IsCover"]:visible').on("click", SetCoverPhoto)
                }
                console.log(previewId)
                newPhotos.push({
                    PreviewId: previewId,
                    FileName:  data.response.Data.FileName,
                    PhotoId: data.response.Data.Id
                })
                console.log(newPhotos)
                //console.log(previewId)
                //console.log(index)
            }).on('filesorted', function(event, params) {
                //console.log('File sorted ', params.previewId, params.oldIndex, params.newIndex, params.stack);
            }).on('filebatchpreupload', function(event, data, jqXHR) {
                //data.form.append('IsCover', $("input#" + previewId).is(":checked"))
            }).on("filesuccessremove", function (event, id, fileindex) { 
                var previewId = $("#"+id).data("previewid")
                $.each(newPhotos, function(i, p){
                    if(p.PreviewId == previewId){
                        console.log(111)
                        $.ajax({
                            type: "post",
                            url: "@Url.Action("DeletePhoto")",
                            data: { photoName: p.FileName },
                            success: function(result){
                                if(result.Message == "操作成功"){
                                    delete newPhotos[i]
                                }
                            }
                        });
                        
                    }
                })
            });

            function addData(photo){
                $.each(photo, function(i, p){
                    var photo     = { extra: {} }
                    photo.caption = p.FileName
                    photo.size    = p.FileSize
                    photo.key     = p.Id
                    photo.width   = "120px"
                    photo.url     = "@Url.Action("DeletePhoto")"
                    photo.extra.photoName = p.FileName
                    
                    initialPreview.push(p.RequestPath)
                    initialPreviewConfig.push(photo)
                });
            }

            
            var SetCoverPhoto = function(){
                var that = $(this)
                var photoName = that.closest("tr").find(".explorer-caption").attr("title")
                console.log(photoName);
                $.ajax({
                    type: "post",
                    url: "@Url.Action("SetCoverPhoto")",
                    data: { photoName: photoName, equipmentId: "@Model.Id" },
                    success: function(result){
                        console.log(result);
                    }
                })
            }
            $('input:radio[name="IsCover"]:visible').on("click", SetCoverPhoto);

            (function selectCoverRadio(){
                var coverPhotoName = "@CoverPhotoName"
                $(".explorer-caption[title='@CoverPhotoName']")
                    .closest("tr")
                    .find('input:radio[name="IsCover"]:visible')
                    .attr('checked', true)
            })()
        })
    </script>
}